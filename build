#!/bin/bash

compiler=dmd
defBuildParams="--compiler=$compiler --force" # --debug=data --debug=tick
if [ $1 ]; then buildType=$1; else buildType=debug; fi
buildParams=${@:2}
rootDir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"

function buildCore {
    cd $rootDir/core &&
    dub build $defBuildParams $buildParams &&
    dub test $defBuildParams $buildParams &&

    export LIBRARY_PATH=$LIBRARY_PATH:$rootDir/core/lib &&
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$rootDir/core/lib
}

function buildLib {
    cd $rootDir/$1 &&
    dub build $defBuildParams $buildParams &&
    dub test $defBuildParams $buildParams &&

    export LIBRARY_PATH=$LIBRARY_PATH:$rootDir/$1/lib &&
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:$rootDir/$1/lib &&

    mkdir -p ../run/bin/lib &&
    cp -fr lib/libflow-$1.so ../run/bin/lib
}

function buildRun {
    cd $rootDir/run &&
    dub build --build $buildType $defBuildParams $buildParams &&
    mkdir -p $rootDir/run/bin/cfg
}

function buildBin {
    cd $rootDir/$1 &&
    dub build --build $buildType $defBuildParams $buildParams
}

buildCore &&
buildRun &&

buildLib complex &&

buildBin complex-gen

